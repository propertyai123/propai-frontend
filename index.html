<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PropAI – Opportunity Map MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox CSS (via UNPKG to bypass ORB + ISP blocks) -->
  <link
    href="https://unpkg.com/mapbox-gl@2.16.1/dist/mapbox-gl.css"
    rel="stylesheet"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }

    body {
      background: #05060a;
      color: #f4f4f5;
      height: 100vh;
      display: flex;
    }

    .app {
      display: flex;
      width: 100%;
    }

    #map {
      flex: 2;
      height: 100vh;
      min-height: 100%;
    }

    .sidebar {
      flex: 1;
      border-left: 1px solid #27272a;
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #fbbf24;
    }

    .subtitle {
      font-size: 12px;
      color: #a1a1aa;
    }

    .pill-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #27272a;
    }

    .pill.gold { border-color: #fbbf24; color: #fbbf24; }
    .pill.silver { border-color: #e5e7eb; color: #e5e7eb; }
    .pill.bronze { border-color: #f97316; color: #f97316; }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #71717a;
      margin-top: 14px;
    }

    .card {
      border-radius: 14px;
      border: 1px solid #27272a;
      background: linear-gradient(135deg, #020617 0, #0b1120 100%);
      padding: 12px 14px;
      margin-top: 6px;
    }

    .card-label { font-size: 11px; color: #a1a1aa; }

    .card-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-top: 6px;
    }

    .score { font-size: 26px; font-weight: 700; }
    .tier { font-size: 13px; padding: 3px 10px; border-radius: 999px; border: 1px solid #27272a; }

    .tier-gold { color: #fbbf24; border-color: #fbbf24; }
    .tier-silver { color: #e5e7eb; border-color: #e5e7eb; }
    .tier-bronze { color: #f97316; border-color: #f97316; }

    .factors {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 12px;
    }

    .factor-label { font-size: 11px; color: #a1a1aa; }
    .factor-bar-track { background: #18181b; height: 4px; width: 100%; border-radius: 999px; }

    .factor-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #fbbf24);
      width: 0%;
      transition: width 0.3s ease-out;
    }

    .list {
      margin-top: 8px;
      max-height: 220px;
      overflow-y: auto;
    }

    .list-item { padding: 8px 0; border-bottom: 1px solid #18181b; cursor: pointer; }
    .list-item-title { font-size: 13px; font-weight: 600; }
    .list-item-meta { font-size: 11px; color: #a1a1aa; }

    .footer {
      margin-top: auto;
      font-size: 10px;
      color: #52525b;
      border-top: 1px solid #18181b;
      padding-top: 10px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="map"></div>

    <aside class="sidebar">
      <div>
        <div class="logo">PropAI</div>
        <div class="subtitle">Real-time opportunity map – Midwest industrial thesis</div>
        <div class="pill-row">
          <div class="pill gold">Gold ≥ 75</div>
          <div class="pill silver">Silver 50–74</div>
          <div class="pill bronze">Bronze &lt; 50</div>
        </div>
      </div>

      <div class="section-title">Selected Parcel</div>
      <div class="card">
        <div class="card-label" id="selected-address">Tap a parcel</div>
        <div class="card-main">
          <span class="score" id="poi-score">–</span>
          <span class="tier" id="poi-tier">No score</span>
        </div>

        <div class="factors">
          <div><div class="factor-label">Value Anomaly</div><div class="factor-bar-track"><div class="factor-bar-fill" id="bar-value"></div></div></div>
          <div><div class="factor-label">Catalyst</div><div class="factor-bar-track"><div class="factor-bar-fill" id="bar-catalyst"></div></div></div>
          <div><div class="factor-label">Asset</div><div class="factor-bar-track"><div class="factor-bar-fill" id="bar-asset"></div></div></div>
          <div><div class="factor-label">Market</div><div class="factor-bar-track"><div class="factor-bar-fill" id="bar-market"></div></div></div>
          <div><div class="factor-label">Incentives</div><div class="factor-bar-track"><div class="factor-bar-fill" id="bar-incentive"></div></div></div>
          <div><div class="factor-label">Risk</div><div class="factor-bar-track"><div class="factor-bar-fill" id="bar-risk"></div></div></div>
        </div>
      </div>

      <div class="section-title">Sample Parcels</div>
      <div class="card">
        <div class="list" id="parcel-list"></div>
      </div>

      <div class="footer">
        MVP prototype – live scoring via PropAI engine
      </div>
    </aside>
  </div>

  <!-- Mapbox JS (via UNPKG to bypass ORB and firewall issues) -->
  <script src="https://unpkg.com/mapbox-gl@2.16.1/dist/mapbox-gl.js" defer></script>

  <script>
    window.addEventListener("load", () => {
      const MAPBOX_TOKEN =
        "pk.eyJ1IjoicHJvcGFpIiwiYSI6ImNtaWpzeGp1aDE2ZTUzZnBzZ3FpdmRuMnkifQ.zsX08ZYuz7ghvXZf-CoUjQ";

      const BACKEND_URL = "https://propai-mvp-production.up.railway.app";

      mapboxgl.accessToken = MAPBOX_TOKEN;

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/dark-v11",
        center: [-86, 40.5],
        zoom: 4.1
      });

      // ------- CATALYST DATA -------
      const catalysts = [
        { id: "gm", name: "GM–LG Ultium (MI)", lat: 42.708, lng: -84.668, radius_miles: 12 },
        { id: "honda", name: "Honda EV (OH)", lat: 40.236, lng: -83.367, radius_miles: 15 },
        { id: "panasonic", name: "Panasonic (KS)", lat: 38.964, lng: -94.97, radius_miles: 15 }
      ];

      // ------- PARCEL DATA -------
      const parcels = [
        { id: "mi1", name: "20 ac – Delta Twp, MI", address: "Rickle St, MI", lat: 42.71, lng: -84.66, state: "MI", acres: 20, price: 2100000, template: "ev-strong" },
        { id: "oh1", name: "15 ac – Marysville, OH", address: "Industrial Pkwy, OH", lat: 40.23, lng: -83.37, state: "OH", acres: 15, price: 1500000, template: "ev-medium" },
        { id: "ks1", name: "5 ac – De Soto, KS", address: "W 95th St, KS", lat: 38.965, lng: -94.965, state: "KS", acres: 5, price: 900000, template: "ev-goldish" }
      ];

      map.on("load", () => {
        // draw catalyst circles
        catalysts.forEach(c => {
          const radiusMeters = c.radius_miles * 1609.34;
          map.addSource(`src-${c.id}`, {
            type: "geojson",
            data: createCircle(c.lng, c.lat, radiusMeters, 64)
          });
          map.addLayer({
            id: `circle-${c.id}`,
            type: "fill",
            source: `src-${c.id}`,
            paint: { "fill-color": "#22c55e", "fill-opacity": 0.08 }
          });
        });

        // parcel markers
        parcels.forEach(parcel => {
          const el = document.createElement("div");
          el.style.width = "12px";
          el.style.height = "12px";
          el.style.borderRadius = "999px";
          el.style.background = "#f97316";
          el.style.boxShadow = "0 0 6px rgba(248,113,113,0.8)";
          el.style.cursor = "pointer";

          new mapboxgl.Marker(el)
            .setLngLat([parcel.lng, parcel.lat])
            .addTo(map)
            .getElement()
            .addEventListener("click", () => handleParcel(parcel));
        });

        renderParcelList();
      });

      function renderParcelList() {
        const list = document.getElementById("parcel-list");
        list.innerHTML = "";
        parcels.forEach(p => {
          const div = document.createElement("div");
          div.className = "list-item";
          div.innerHTML = `
            <div class="list-item-title">${p.name}</div>
            <div class="list-item-meta">${p.state} • ${p.acres} ac • $${(p.price/1e6).toFixed(2)}M</div>
          `;
          div.addEventListener("click", () => handleParcel(p));
          list.appendChild(div);
        });
      }

      function createCircle(lng, lat, radiusMeters, points) {
        const coords = [];
        const dX = radiusMeters / (111320 * Math.cos((lat * Math.PI) / 180));
        const dY = radiusMeters / 110540;

        for (let i=0; i<points; i++){
          const theta = (i/points) * 2 * Math.PI;
          coords.push([lng + dX * Math.cos(theta), lat + dY * Math.sin(theta)]);
        }
        coords.push(coords[0]);
        return { type:"Feature", geometry:{ type:"Polygon", coordinates:[coords] }};
      }

      async function handleParcel(parcel) {
        document.getElementById("selected-address").textContent = parcel.address;
        document.getElementById("poi-score").textContent = "…";
        document.getElementById("poi-tier").textContent = "Scoring…";

        const payload = { 
          price_anomaly: 0.7, replacement_delta: 0.6, historical_delta: 0.6,
          dom_score: 0.5, distance_score: 0.8, capex_score: 0.8,
          jobs_score: 0.7, sector_rel: 1, cluster: 0.6, media_tone: 0.5,
          recency_multiplier: 0.1, zoning_flex: 0.7, utilities: 0.7,
          topo_index: 0.6, job_growth: 0.5, permits: 0.5, population: 0.4,
          traffic: 0.45, macro_cycle: 0.5, inst_cluster: 0.5,
          oz: 1, hub: 0.7, tif: 0.8, crime: 0.2,
          flood: 0, wildfire: 0.1, epa: 0.1
        };

        try {
          const res = await fetch(BACKEND_URL + "/score", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();

          document.getElementById("poi-score").textContent = data.poi;
          const tier = data.tier.toLowerCase();
          const tierEl = document.getElementById("poi-tier");

          tierEl.textContent = data.tier;
          tierEl.className = "tier tier-" + tier;

        } catch (err) {
          console.error(err);
          document.getElementById("poi-score").textContent = "–";
          document.getElementById("poi-tier").textContent = "Error";
        }
      }
    });
  </script>
</body>
</html>
